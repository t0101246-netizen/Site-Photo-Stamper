<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å·¥ç¨‹ç›¸æ©Ÿ v3.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body { 
            margin: 0; padding: 0; 
            background: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            height: 100vh; /* ä½¿ç”¨ dvh é¿å…ç¶²å€åˆ—é®æ“‹å•é¡Œ */
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- ç›¸æ©Ÿå€ (ä½”æ»¿å‰©é¤˜ç©ºé–“) --- */
        .camera-container { 
            flex: 1; 
            position: relative; 
            background: #000; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        canvas { display: none; }

        /* è¢å¹•ä¸Šçš„é è¦½æ–‡å­— (åŠ å¤§) */
        .overlay-preview { 
            position: absolute; 
            bottom: 10px; 
            left: 10px; 
            right: 10px;
            padding: 15px; 
            background: rgba(0,0,0,0.5); 
            border-radius: 8px;
            pointer-events: none; 
            text-shadow: 1px 1px 2px black; 
            z-index: 10; 
        }
        .preview-row { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 4px; 
            font-size: 1.1rem; /* é è¦½æ–‡å­—æ”¾å¤§ */
            color: white;
            line-height: 1.4;
        }
        .p-label { 
            color: #f59e0b; 
            font-weight: bold; 
            min-width: 85px; /* æ¨™ç±¤å¯¬åº¦åŠ å¤§ */
        }

        /* --- æ§åˆ¶é¢æ¿ (åŠ å¤§è§¸æ§å€) --- */
        .controls { 
            background: #1a1a1a; 
            padding: 20px 15px 30px 15px; /* åº•éƒ¨åŠ å¯¬ï¼Œé¿é–‹æ‰‹æ©Ÿæ©«æ¢ */
            border-radius: 20px 20px 0 0; 
            z-index: 20; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        /* è¼¸å…¥æ¡†çµ„ï¼šä¸Šä¸‹æ’åˆ—ï¼Œæ›´å¤§ */
        .input-group { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* å·¦å³å„åŠ */
            gap: 12px; 
            margin-bottom: 15px; 
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ï¼šæš´åŠ›åŠ å¤§ */
        input, select { 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            padding: 15px; /* å¢åŠ å…§è·ï¼Œå¥½é»æ“Š */
            border-radius: 10px; 
            width: 100%; 
            font-size: 18px; /* å­—é«” 16px ä»¥ä¸Šï¼Œé˜²æ­¢ iPhone è‡ªå‹•ç¸®æ”¾ */
            box-sizing: border-box; 
            appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
        }
        input:focus { 
            border-color: #f59e0b; 
            outline: none; 
            background: #444; 
        }

        /* æŒ‰éˆ•å€ï¼šåŠ å¤§é–“è· */
        .actions { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            margin-top: 10px; 
        }

        /* æ‹ç…§æŒ‰éˆ•ï¼šè¶…ç´šå¤§ */
        .btn-shutter-outer {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .btn-shutter-inner {
            width: 68px;
            height: 68px;
            background: white;
            border-radius: 50%;
            transition: 0.1s;
        }
        .btn-shutter-outer:active .btn-shutter-inner {
            transform: scale(0.9);
            background: #f59e0b;
        }

        /* åŠŸèƒ½å°æŒ‰éˆ• (å®šä½/ç›¸ç°¿) */
        .btn-icon { 
            background: #333; 
            border: none; 
            color: white; 
            font-size: 1.8rem; 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- çµæœå½ˆçª— --- */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        .modal img { 
            max-width: 95%; 
            max-height: 75%; 
            border: 2px solid white; 
            object-fit: contain; 
        }
        .modal-actions { 
            margin-top: 30px; 
            display: flex; 
            gap: 30px; 
            width: 100%;
            justify-content: center;
        }
        .btn-big-action {
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            min-width: 120px;
        }
        .btn-save { background: #f59e0b; color: black; }
        .btn-cancel { background: #444; color: white; }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            padding-bottom: 10px;
            color: #999; 
            font-size: 0.9rem;
        }
        .toggle-cam-btn {
            background: #444;
            padding: 5px 12px;
            border-radius: 15px;
            color: white;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <div class="overlay-preview">
            <div class="preview-row"><span class="p-label">å·¥ç¨‹</span><span id="p-proj">--</span></div>
            <div class="preview-row"><span class="p-label">é …ç›®</span><span id="p-item">--</span></div>
            <div class="preview-row"><span class="p-label">æ™‚é–“</span><span id="p-time">--</span></div>
            <div class="preview-row" style="font-size: 0.9rem; color:#ccc;">
                <span class="p-label">GPS</span><span id="p-loc">å®šä½ä¸­...</span>
            </div>
        </div>
    </div>
    
    <canvas id="canvas"></canvas>

    <div class="controls">
        <div class="top-bar">
            <span>ğŸ“· å·¥ç¨‹ç´€éŒ„æ¨¡å¼</span>
            <span class="toggle-cam-btn" onclick="toggleCam()">ğŸ”„ ç¿»è½‰é¡é ­</span>
        </div>

        <div class="input-group">
            <input type="text" id="inpProj" placeholder="å·¥ç¨‹åç¨± (BC11)" oninput="updatePreview()">
            <input type="text" id="inpItem" placeholder="æ–½å·¥é …ç›® (Test)" oninput="updatePreview()">
        </div>
        <div class="input-group">
            <input type="text" id="inpUser" placeholder="æª¢æŸ¥äººå“¡" oninput="updatePreview()">
            <select id="inpWeather" onchange="updatePreview()">
                <option value="æ™´">â˜€ æ™´</option>
                <option value="é™°">â˜ é™°</option>
                <option value="é›¨">ğŸŒ§ é›¨</option>
            </select>
        </div>

        <div class="actions">
            <button class="btn-icon" onclick="getLocation()" title="é‡æ–°å®šä½">ğŸ“</button>
            
            <div class="btn-shutter-outer" onclick="takePhoto()">
                <div class="btn-shutter-inner"></div>
            </div>

            <button class="btn-icon" onclick="openGallery()" title="ç›¸ç°¿">ğŸ“‚</button>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <img id="finalImage" alt="Result">
        <div class="modal-actions">
            <button class="btn-big-action btn-cancel" onclick="closeModal()">âœ– é‡æ‹</button>
            <button class="btn-big-action btn-save" onclick="downloadImage()">â¬‡ å„²å­˜ç…§ç‰‡</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        let stream = null;
        let facingMode = 'environment'; 

        // 1. åˆå§‹åŒ–ç›¸æ©Ÿ
        async function initCamera() {
            try {
                if (stream) stream.getTracks().forEach(track => track.stop());
                // å¼·åˆ¶è«‹æ±‚é«˜è§£æåº¦
                const constraints = { 
                    video: { 
                        facingMode: facingMode, 
                        width: { ideal: 3840 }, // å˜—è©¦è«‹æ±‚ 4K
                        height: { ideal: 2160 } 
                    } 
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                updateTime();
                getLocation();
            } catch (err) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™ã€‚\nError: " + err.message); }
        }

        function toggleCam() { facingMode = facingMode === 'environment' ? 'user' : 'environment'; initCamera(); }

        function updateTime() {
            const now = new Date();
            const str = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('p-time').innerText = str;
            requestAnimationFrame(updateTime);
        }

        function updatePreview() {
            document.getElementById('p-proj').innerText = document.getElementById('inpProj').value || "--";
            document.getElementById('p-item').innerText = document.getElementById('inpItem').value || "--";
        }

        function getLocation() {
            document.getElementById('p-loc').innerText = "å®šä½ä¸­...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('p-loc').innerText = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                }, (err) => { document.getElementById('p-loc').innerText = "å®šä½å¤±æ•—"; });
            }
        }

        // 2. æ‹ç…§èˆ‡æµ®æ°´å°åˆæˆ (æ ¸å¿ƒä¿®æ”¹è™•)
        function takePhoto() {
            const ctx = canvas.getContext('2d');
            // è¨­å®šç•«å¸ƒç‚ºè¦–è¨ŠåŸå§‹è§£æåº¦ (é€šå¸¸å¾ˆå¤§ï¼Œå¦‚ 4000x3000)
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            
            // ç¹ªè£½ç…§ç‰‡
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // --- æµ®æ°´å°è¨­å®š (æš´åŠ›åŠ å¤§ç‰ˆ) ---
            // é»‘åº•é«˜åº¦ï¼šä½”ç•«é¢çš„ 30% (ä¹‹å‰æ˜¯25%ï¼ŒåŠ å¤§ä»¥å®¹ç´å¤§å­—)
            const barHeight = canvas.height * 0.3; 
            const yStart = canvas.height - barHeight;
            
            // åŠé€æ˜é»‘åº•
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)"; 
            ctx.fillRect(0, yStart, canvas.width, barHeight);

            // æŠ“å–æ–‡å­—
            const proj = document.getElementById('inpProj').value || "æœªå‘½åå·¥ç¨‹";
            const item = document.getElementById('inpItem').value || "æ–½å·¥ç´€éŒ„";
            const user = document.getElementById('inpUser').value || "";
            const weather = document.getElementById('inpWeather').value;
            const time = document.getElementById('p-time').innerText;
            const loc = document.getElementById('p-loc').innerText;

            // --- å­—é«”å¤§å°è¨ˆç®— (é—œéµä¿®æ”¹) ---
            // ä½¿ç”¨ç•«é¢å¯¬åº¦çš„ 7% ä½œç‚ºå¤§å­—é«” (ä¹‹å‰ç´„ 4%)
            // ä½¿ç”¨ç•«é¢å¯¬åº¦çš„ 5% ä½œç‚ºå°å­—é«”
            const fontSizeMain = canvas.width * 0.07; 
            const fontSizeSub = canvas.width * 0.05;  
            const padding = canvas.width * 0.05; // é‚Šè·ä¹ŸåŠ å¤§
            const lineHeight = fontSizeMain * 1.5;

            ctx.textBaseline = "top";
            
            // Line 1: å·¥ç¨‹åç¨± (é»ƒè‰², ç‰¹å¤§)
            ctx.font = `bold ${fontSizeMain}px Arial`; 
            ctx.fillStyle = "#f59e0b"; 
            ctx.fillText("å·¥ç¨‹: " + proj, padding, yStart + padding);

            // Line 2: æ–½å·¥é …ç›® (ç™½, å¤§)
            ctx.fillStyle = "white"; 
            ctx.font = `bold ${fontSizeSub}px Arial`; 
            ctx.fillText("é …ç›®: " + item, padding, yStart + padding + lineHeight);

            // Line 3: äººå“¡å¤©æ°£
            ctx.font = `${fontSizeSub}px Arial`;
            ctx.fillText(`äººå“¡: ${user}   å¤©æ°£: ${weather}`, padding, yStart + padding + lineHeight * 2);

            // Line 4: æ™‚é–“
            ctx.fillText("æ™‚é–“: " + time, padding, yStart + padding + lineHeight * 3);
            
            // Line 5: GPS (ç°è‰², ç¨å°)
            ctx.fillStyle = "#ddd";
            ctx.font = `${fontSizeSub * 0.8}px Arial`;
            ctx.fillText(loc, padding, yStart + padding + lineHeight * 4);

            // é¡¯ç¤ºçµæœ
            document.getElementById('finalImage').src = canvas.toDataURL('image/jpeg', 0.95);
            document.getElementById('resultModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('resultModal').style.display = 'none'; }
        
        function downloadImage() {
            const link = document.createElement('a');
            const timeStr = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `SitePhoto_${timeStr}.jpg`;
            link.href = document.getElementById('finalImage').src;
            link.click();
            closeModal();
        }
        
        function openGallery() { alert("è«‹ä½¿ç”¨ã€Œå„²å­˜ç…§ç‰‡ã€å¾Œè‡³æ‰‹æ©Ÿç›¸ç°¿æŸ¥çœ‹"); }

        window.addEventListener('load', initCamera);
        
        // PWA è¨»å†Š
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
