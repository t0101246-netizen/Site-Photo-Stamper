<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å·¥ç¨‹ç›¸æ©Ÿ v3.2 (å·¨ç„¡éœ¸ç‰ˆ)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        /* --- å…¨å±€åŸºç¤è¨­å®š --- */
        body { 
            margin: 0; padding: 0; background: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            height: 100dvh; /* æ»¿ç‰ˆé«˜åº¦ */
            display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- ç›¸æ©Ÿé è¦½å€ --- */
        .camera-container { 
            flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            position: relative; background: #000; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }

        /* --- è¢å¹•é è¦½æµ®æ°´å° (åŠ å¤§ç‰ˆ) --- */
        .overlay-preview { 
            position: absolute; bottom: 10px; left: 10px; right: 10px;
            padding: 15px; background: rgba(0,0,0,0.6); border-radius: 12px;
            pointer-events: none; text-shadow: 2px 2px 4px black; z-index: 10; 
        }
        .preview-row { 
            display: flex; gap: 15px; margin-bottom: 6px; 
            font-size: 1.3rem; /* å­—é«”åŠ å¤§ */
            color: white; line-height: 1.4;
            align-items: center;
        }
        .p-label { 
            color: #f59e0b; font-weight: bold; min-width: 60px; font-size: 1rem;
            background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; text-align: center;
        }

        /* --- æ§åˆ¶é¢æ¿ (æ ¸å¿ƒä¿®æ”¹å€) --- */
        .controls { 
            background: #1a1a1a; 
            padding: 15px 20px 30px 20px; 
            border-radius: 25px 25px 0 0; 
            z-index: 20; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 12px;
            max-height: 50vh; /* é˜²æ­¢è“‹ä½å¤ªå¤šç•«é¢ï¼Œå¯æ²å‹• */
            overflow-y: auto;
        }

        .top-bar { 
            display: flex; justify-content: space-between; align-items: center;
            color: #bbb; font-size: 0.9rem; margin-bottom: 5px;
        }
        .toggle-cam-btn {
            background: #444; padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold;
        }

        /* --- è¼¸å…¥æ¡†æ¨£å¼ (Jumbo Size) --- */
        /* å–®åˆ—è¼¸å…¥ (å·¥ç¨‹åç¨±/é …ç›®) */
        .input-full { width: 100%; }
        
        /* é›™åˆ—è¼¸å…¥ (äººå“¡/å¤©æ°£) */
        .input-row { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }

        input, select { 
            background: #333; border: 2px solid #555; color: white; 
            padding: 12px 15px; /* å…§è·åŠ å¤§ */
            border-radius: 12px; width: 100%; 
            font-size: 20px; /* å­—é«” 20pxï¼Œæ‰‹æŒ‡å¥½é»ï¼Œä¸”çœ‹å¾—æ¸…æ¥š */
            height: 55px; /* é«˜åº¦å›ºå®šï¼Œå¥½æŒ‰ */
            box-sizing: border-box; appearance: none; font-weight: bold;
        }
        input::placeholder { color: #888; font-weight: normal; font-size: 18px; }
        input:focus { border-color: #f59e0b; outline: none; background: #444; }

        /* --- æ‹ç…§æŒ‰éˆ•å€ --- */
        .actions { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 10px; padding: 0 10px;
        }

        .btn-shutter-outer {
            width: 85px; height: 85px; border-radius: 50%; border: 5px solid white;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn-shutter-inner {
            width: 70px; height: 70px; background: white; border-radius: 50%; transition: 0.1s;
        }
        .btn-shutter-outer:active .btn-shutter-inner { transform: scale(0.9); background: #f59e0b; }

        .btn-icon { 
            background: #333; border: 1px solid #555; color: white; font-size: 1.6rem; 
            width: 60px; height: 60px; border-radius: 50%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }

        /* --- çµæœå½ˆçª— --- */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .modal img { 
            max-width: 95%; max-height: 75%; border: 2px solid white; object-fit: contain; 
        }
        .modal-actions { 
            margin-top: 30px; display: flex; gap: 20px; width: 100%; justify-content: center;
        }
        .btn-big-action {
            padding: 18px 40px; border-radius: 40px; font-size: 1.2rem; 
            font-weight: bold; border: none; min-width: 140px; cursor: pointer;
        }
        .btn-save { background: #f59e0b; color: black; }
        .btn-cancel { background: #444; color: white; }
    </style>
</head>
<body>

    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <div class="overlay-preview">
            <div class="preview-row"><span class="p-label">å·¥ç¨‹</span><span id="p-proj">--</span></div>
            <div class="preview-row"><span class="p-label">é …ç›®</span><span id="p-item">--</span></div>
            <div class="preview-row" style="font-size: 1rem; color:#ddd;">
                <span id="p-time">--</span> | <span id="p-loc">GPS...</span>
            </div>
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <div class="top-bar">
            <span>ğŸ“· v3.2 å·¨ç„¡éœ¸ä»‹é¢</span>
            <span class="toggle-cam-btn" onclick="toggleCam()">ğŸ”„ ç¿»è½‰</span>
        </div>
        
        <div class="input-full">
            <input type="text" id="inpProj" placeholder="å·¥ç¨‹åç¨± (ä¾‹: Aæ£Ÿå¤§æ¨“)" oninput="updatePreview()">
        </div>
        <div class="input-full">
            <input type="text" id="inpItem" placeholder="æ–½å·¥é …ç›® (ä¾‹: 3Fæ¨‘é…ç­‹)" oninput="updatePreview()">
        </div>

        <div class="input-row">
            <input type="text" id="inpUser" placeholder="æª¢æŸ¥äººå“¡" oninput="updatePreview()">
            <select id="inpWeather" onchange="updatePreview()">
                <option value="æ™´">â˜€ æ™´</option>
                <option value="é™°">â˜ é™°</option>
                <option value="é›¨">ğŸŒ§ é›¨</option>
            </select>
        </div>

        <div class="actions">
            <button class="btn-icon" onclick="getLocation()" title="é‡æ–°å®šä½">ğŸ“</button>
            <div class="btn-shutter-outer" onclick="takePhoto()"><div class="btn-shutter-inner"></div></div>
            <button class="btn-icon" onclick="openGallery()" title="ç›¸ç°¿">ğŸ“‚</button>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <img id="finalImage" alt="Result">
        <div class="modal-actions">
            <button class="btn-big-action btn-cancel" onclick="closeModal()">âœ– é‡æ‹</button>
            <button class="btn-big-action btn-save" onclick="downloadImage()">â¬‡ å„²å­˜</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        let stream = null;
        let facingMode = 'environment'; 

        async function initCamera() {
            try {
                if (stream) stream.getTracks().forEach(track => track.stop());
                const constraints = { video: { facingMode: facingMode, width: { ideal: 3840 }, height: { ideal: 2160 } } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                updateTime();
                getLocation();
            } catch (err) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™ã€‚\nError: " + err.message); }
        }

        function toggleCam() { facingMode = facingMode === 'environment' ? 'user' : 'environment'; initCamera(); }

        function updateTime() {
            const now = new Date();
            const str = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('p-time').innerText = str;
            requestAnimationFrame(updateTime);
        }

        function updatePreview() {
            document.getElementById('p-proj').innerText = document.getElementById('inpProj').value || "--";
            document.getElementById('p-item').innerText = document.getElementById('inpItem').value || "--";
        }

        function getLocation() {
            document.getElementById('p-loc').innerText = "å®šä½ä¸­...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('p-loc').innerText = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                }, (err) => { document.getElementById('p-loc').innerText = "å®šä½å¤±æ•—"; });
            }
        }

        // --- æ‹ç…§èˆ‡è‡ªå‹•æ—‹è½‰ (v3.1 é‚è¼¯ä¿ç•™) ---
        function takePhoto() {
            const ctx = canvas.getContext('2d');
            const vWidth = video.videoWidth;
            const vHeight = video.videoHeight;

            // 1. åµæ¸¬æ–¹å‘
            let orientationType = (screen.orientation || {}).type || window.orientation;
            let rotation = 0; 
            if (orientationType === 'landscape-primary' || window.orientation === 90) rotation = 90;
            else if (orientationType === 'landscape-secondary' || window.orientation === -90) rotation = -90;
            else if (orientationType === 'portrait-secondary' || window.orientation === 180) rotation = 180;

            // 2. è¨­å®šç•«å¸ƒ
            if (Math.abs(rotation) === 90) { canvas.width = vHeight; canvas.height = vWidth; } 
            else { canvas.width = vWidth; canvas.height = vHeight; }

            // 3. æ—‹è½‰ç¹ªè£½
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rotation * Math.PI / 180);
            if (Math.abs(rotation) === 90) ctx.drawImage(video, -vWidth / 2, -vHeight / 2, vWidth, vHeight);
            else ctx.drawImage(video, -vWidth / 2, -vHeight / 2, vWidth, vHeight);
            ctx.restore();

            // --- æµ®æ°´å°ç¹ªè£½ (å­—é«”ä¾èˆŠç¶­æŒå¤§æ¯”ä¾‹) ---
            const barHeight = canvas.height * 0.3; 
            const yStart = canvas.height - barHeight;
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)"; 
            ctx.fillRect(0, yStart, canvas.width, barHeight);

            const proj = document.getElementById('inpProj').value || "æœªå‘½åå·¥ç¨‹";
            const item = document.getElementById('inpItem').value || "æ–½å·¥ç´€éŒ„";
            const user = document.getElementById('inpUser').value || "";
            const weather = document.getElementById('inpWeather').value;
            const time = document.getElementById('p-time').innerText;
            const loc = document.getElementById('p-loc').innerText;

            const fontSizeMain = canvas.width * 0.07; 
            const fontSizeSub = canvas.width * 0.05;  
            const padding = canvas.width * 0.05;
            const lineHeight = fontSizeMain * 1.5;

            ctx.textBaseline = "top";
            ctx.font = `bold ${fontSizeMain}px Arial`; ctx.fillStyle = "#f59e0b"; 
            ctx.fillText("å·¥ç¨‹: " + proj, padding, yStart + padding);
            ctx.fillStyle = "white"; ctx.font = `bold ${fontSizeSub}px Arial`; 
            ctx.fillText("é …ç›®: " + item, padding, yStart + padding + lineHeight);
            ctx.font = `${fontSizeSub}px Arial`;
            ctx.fillText(`äººå“¡: ${user}   å¤©æ°£: ${weather}`, padding, yStart + padding + lineHeight * 2);
            ctx.fillText("æ™‚é–“: " + time, padding, yStart + padding + lineHeight * 3);
            ctx.fillStyle = "#ddd"; ctx.font = `${fontSizeSub * 0.8}px Arial`;
            ctx.fillText(loc, padding, yStart + padding + lineHeight * 4);

            document.getElementById('finalImage').src = canvas.toDataURL('image/jpeg', 0.95);
            document.getElementById('resultModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('resultModal').style.display = 'none'; }
        
        function downloadImage() {
            const link = document.createElement('a');
            const timeStr = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `SitePhoto_${timeStr}.jpg`;
            link.href = document.getElementById('finalImage').src;
            link.click();
            closeModal();
        }
        function openGallery() { alert("è«‹ä½¿ç”¨ã€Œå„²å­˜ç…§ç‰‡ã€å¾Œè‡³æ‰‹æ©Ÿç›¸ç°¿æŸ¥çœ‹"); }
        window.addEventListener('load', initCamera);
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
